<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iris's Secret Garden ğŸŒ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); --text-color: #5d4037; --glass-bg: rgba(255, 255, 255, 0.6); --glass-border: rgba(255, 255, 255, 0.8); --accent: #d81b60; --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        body.night-mode { --bg-gradient: linear-gradient(to top, #30cfd0 0%, #330867 100%); --text-color: #fff; --glass-bg: rgba(0, 0, 0, 0.3); --glass-border: rgba(255, 255, 255, 0.1); --accent: #ff9a9e; --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        body { font-family: 'Nunito', sans-serif; background: var(--bg-gradient); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; text-align: center; transition: all 0.8s ease; background-attachment: fixed; }
        /* ä¿®å¤ï¼šå»æ‰ overflow: hiddenï¼Œé˜²æ­¢å†…å®¹è¢«åˆ‡æ‰ */
        .container { background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); padding: 0 0 40px 0; border-radius: 30px; box-shadow: var(--shadow); width: 95%; max-width: 600px; margin: 0 auto; position: relative; z-index: 10; transition: all 0.5s ease; margin-bottom: 50px; }
        
        /* ä¿®å¤ï¼šæ¨±èŠ±å±‚çº§æœ€é«˜ï¼Œä¸”ä¸é˜»æŒ¡ç‚¹å‡» */
        .sakura-petal { pointer-events: none; z-index: 99999 !important; }

        /* ä¿®å¤ï¼šTTS æŒ‰é’®ä½ç½®å¾®è°ƒï¼Œç¡®ä¿ä¸è¢«é®æŒ¡ */
        .tts-play-btn { bottom: -45px; right: 10px; }
        @media (min-width: 900px) { .container { max-width: 1100px; } .content-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; padding: 0 40px; text-align: left; } .header-area { text-align: center; margin-bottom: 40px; } .section-title { font-size: 1.4em; margin-bottom: 20px; border-bottom: 2px solid var(--accent); display: inline-block; } }
        @media (max-width: 899px) { .content-grid { display: flex; flex-direction: column; gap: 30px; padding: 0 20px; } .header-area { text-align: center; } .section-title { font-size: 1.2em; margin-bottom: 15px; border-bottom: 1px dashed var(--accent); display: inline-block; } }
        .banner-css { width: 100%; height: 180px; background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--glass-border); position: relative; overflow: hidden; }
        .banner-css::after { content: "ğŸŒ¸"; font-size: 8rem; opacity: 0.2; position: absolute; animation: float 6s ease-in-out infinite; }
        h1 { font-family: 'Dancing Script', cursive; color: var(--accent); font-size: 3em; margin: 20px 0 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .magic-switch { position: absolute; top: 20px; right: 20px; font-size: 1.8em; cursor: pointer; background: none; border: none; transition: transform 0.3s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); z-index: 20; }
        .magic-switch:hover { transform: scale(1.2) rotate(20deg); }
        .garden { display: flex; justify-content: center; gap: 25px; margin-bottom: 30px; flex-wrap: wrap; min-height: 100px; }
        .flower-item { position: relative; cursor: pointer; transition: transform 0.3s; }
        .flower-item:hover { transform: scale(1.3) rotate(5deg); }
        .flower-emoji { font-size: 3em; display: block; animation: float 4s ease-in-out infinite; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }
        .flower-item:nth-child(odd) .flower-emoji { animation-duration: 4s; }
        .flower-item:nth-child(even) .flower-emoji { animation-duration: 5s; }
        .flower-tooltip { visibility: hidden; width: max-content; background-color: var(--accent); color: #fff; text-align: center; border-radius: 20px; padding: 8px 15px; position: absolute; z-index: 1; bottom: 110%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 0.9em; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .flower-item:hover .flower-tooltip { visibility: visible; opacity: 1; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .diary-container { max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .diary-container::-webkit-scrollbar { width: 6px; }
        .diary-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
        .diary-container::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; opacity: 0.5; }
        .diary-card { background: rgba(255, 255, 255, 0.5); border-left: 5px solid var(--accent); border-radius: 10px; padding: 20px; margin-bottom: 15px; text-align: left; transition: all 0.5s; position: relative; }
        body.night-mode .diary-card { background: rgba(0, 0, 0, 0.4); }
        .diary-date { font-size: 0.8em; color: var(--accent); font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; display: block; }
        .diary-content { font-size: 1.05em; line-height: 1.6; font-style: italic; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; }
        .polaroid { background: #fff; padding: 8px 8px 25px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: rotate(var(--rotation)); transition: transform 0.3s, z-index 0.3s; cursor: pointer; position: relative; }
        .polaroid:hover { transform: scale(1.1) rotate(0deg); z-index: 100; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .painting { width: 100%; height: 100px; background-color: #eee; }
        .painting-starry { background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%); position: relative; overflow: hidden; }
        .painting-starry::after { content: "âœ¨"; position: absolute; top: 10px; left: 10px; font-size: 20px; text-shadow: 30px 40px 0 yellow, 70px 10px 0 white; }
        .painting-pond { background: radial-gradient(circle at 30% 30%, #a8e6cf 0%, #11998e 100%); position: relative; }
        .painting-pond::before { content: "ğŸŒ¸"; position: absolute; bottom: 10px; right: 20px; font-size: 24px; opacity: 0.8; }
        .painting-forest { background: linear-gradient(to bottom right, #56ab2f 0%, #a8e063 100%); position: relative; }
        .painting-forest::after { content: "ğŸŒ²"; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); font-size: 40px; opacity: 0.5; }
        .polaroid-caption { font-family: 'Dancing Script', cursive; font-size: 0.9em; color: #555; position: absolute; bottom: 5px; width: 100%; left: 0; text-align: center; }
        .playlist { display: flex; flex-direction: column; gap: 10px; }
        .track-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 12px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 10px; transition: all 0.3s; color: var(--text-color); font-family: 'Nunito', sans-serif; font-weight: 600; text-align: left; }
        .track-btn:hover, .track-btn.active { background: var(--accent); color: white; transform: translateX(5px); box-shadow: 0 5px 15px rgba(216, 27, 96, 0.3); }
        .track-info { display: flex; align-items: center; gap: 10px; }
        .track-icon { font-size: 1.2em; }
        .playing-indicator { font-size: 0.8em; opacity: 0; transition: opacity 0.3s; }
        .track-btn.active .playing-indicator { opacity: 1; }
        .bilibili-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; border-radius: 15px; overflow: hidden; margin-bottom: 20px; border: 2px solid var(--glass-border); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .bilibili-iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .firefly { position: fixed; left: 50%; top: 50%; width: 0.4vw; height: 0.4vw; margin: -0.2vw 0 0 9.8vw; animation: ease 200s alternate infinite; pointer-events: none; z-index: 0; }
        .firefly::before, .firefly::after { content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%; transform-origin: -10vw; }
        .firefly::before { background: rgba(255,255,0,0.2); opacity: 0.4; animation: drift ease alternate infinite; }
        .firefly::after { background: white; opacity: 0; box-shadow: 0 0 0vw 0vw yellow; animation: drift ease alternate infinite, flash ease infinite; }
        @keyframes drift { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes flash { 0%, 30%, 100% { opacity: 0; box-shadow: 0 0 0vw 0vw yellow; } 5% { opacity: 1; box-shadow: 0 0 2vw 0.4vw yellow; } }
        .click-heart { position: absolute; font-size: 24px; pointer-events: none; animation: float-up 1.5s ease-out forwards; z-index: 100; }
        @keyframes float-up { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.5); opacity: 0; } }
        .footer { margin-top: 40px; font-size: 0.8em; opacity: 0.7; padding-bottom: 20px; width: 100%; text-align: center; grid-column: span 2; }
        .npc-container { position: fixed; bottom: 0; right: 5%; width: 300px; height: 400px; z-index: 1000; pointer-events: none; }
        .npc-image { width: 100%; height: 100%; object-fit: cover; object-position: top center; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); transition: transform 0.3s, filter 0.3s; cursor: pointer; pointer-events: auto; transform-origin: bottom center; }
        .npc-image:hover { transform: scale(1.05) translateY(-5px); filter: drop-shadow(0 0 15px rgba(255,182,193,0.8)); }
        .dialogue-box { position: absolute; bottom: 380px; right: 20px; background: rgba(255, 255, 255, 0.9); padding: 15px 20px; border-radius: 20px; border: 2px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.1); font-family: 'Nunito', sans-serif; color: var(--text-color); max-width: 250px; opacity: 0; transform: translateY(20px); transition: all 0.3s; pointer-events: auto; }
        .dialogue-box.show { opacity: 1; transform: translateY(0); }
        .dialogue-box::after { content: ''; position: absolute; bottom: -10px; right: 40px; border-width: 10px 10px 0; border-style: solid; border-color: var(--accent) transparent transparent transparent; }
        .chat-input-box { position: absolute; bottom: 10px; right: 280px; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; gap: 5px; z-index: 2000; pointer-events: auto; opacity: 0; transform: translateY(10px); transition: all 0.3s; }
        .chat-input-box.show { opacity: 1; transform: translateY(0); }
        #chat-input { border: 1px solid #ddd; padding: 8px 12px; border-radius: 15px; outline: none; font-family: 'Nunito'; width: 180px; }
        .chat-input-box button { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-family: 'Nunito'; font-weight: bold; }
        /* TTS æŒ‰é’®å¢å¼º */
        .tts-play-btn { position: absolute; bottom: -40px; right: 0; background: #fff; border: 2px solid var(--accent); border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 1.2em; line-height: 32px; text-align: center; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .tts-play-btn:active { transform: scale(0.9); }
        @media (max-width: 600px) {
            .npc-container { width: 160px; height: 220px; right: -20px; }
            .dialogue-box { bottom: 230px; right: 10px; max-width: 180px; font-size: 0.85em; }
            .chat-input-box { right: 10px; bottom: 220px; width: 200px; flex-direction: column; }
            #chat-input { width: 100%; }
        }
    </style>
</head>
<body>

    <button class="magic-switch" onclick="toggleNightMode()" title="åˆ‡æ¢æ˜¼å¤œ">ğŸŒ™</button>

    <div class="container">
        <div class="banner-css"></div>
        <div class="header-area">
            <h1>Iris's Secret Garden</h1>
            <div class="garden"></div>
        </div>

        <div class="content-grid">
            <div class="left-col">
                <div class="section-title" style="color: var(--accent); font-family: 'Dancing Script'; font-size: 1.5em; border-bottom: 1px dashed var(--accent); margin-bottom: 15px;">âœ¨ Mood Diary</div>
                <div class="diary-container" id="diary-container"><div class="diary-card"><div class="diary-content">æ­£åœ¨æ‰¾å›ä¸¢å¤±çš„è®°å¿†... ğŸ“–</div></div></div>
                <div class="section-title" style="color: var(--accent); font-family: 'Dancing Script'; font-size: 1.5em; border-bottom: 1px dashed var(--accent); margin-bottom: 15px; margin-top: 30px;">ğŸ–¼ï¸ Memory Gallery</div>
                <div class="gallery-grid">
                    <div class="polaroid" style="--rotation: -3deg;"><div class="painting painting-starry"></div><div class="polaroid-caption">Dreamy</div></div>
                    <div class="polaroid" style="--rotation: 2deg;"><div class="painting painting-pond"></div><div class="polaroid-caption">Peaceful</div></div>
                    <div class="polaroid" style="--rotation: -2deg;"><div class="painting painting-forest"></div><div class="polaroid-caption">Hopeful</div></div>
                </div>
            </div>

            <div class="right-col">
                <div class="section-title" style="color: var(--accent); font-family: 'Dancing Script'; font-size: 1.5em; border-bottom: 1px dashed var(--accent); margin-bottom: 15px;">ğŸµ Music Box</div>
                <div class="bilibili-container">
                    <iframe id="bili-player" class="bilibili-iframe" src="//player.bilibili.com/player.html?bvid=BV1jA411L7fe&page=1&high_quality=1&danmaku=0" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>
                </div>
                <div class="playlist">
                    <button class="track-btn active" onclick="changeVideo(this, 'BV1jA411L7fe')"><span class="track-icon">â˜•</span><div style="text-align:left;"><div style="font-weight:bold;">Relaxing Jazz</div><div style="font-size:0.7em; opacity:0.8;">Cafe Vibes</div></div></button>
                    <button class="track-btn" onclick="changeVideo(this, 'BV1Np4y1V7cd')"><span class="track-icon">ğŸŒ²</span><div style="text-align:left;"><div style="font-weight:bold;">cardigan</div><div style="font-size:0.7em; opacity:0.8;">Lyric Video</div></div></button>
                    <button class="track-btn" onclick="changeVideo(this, 'BV1c4v1e1ERF')"><span class="track-icon">ğŸ‚</span><div style="text-align:left;"><div style="font-weight:bold;">willow</div><div style="font-size:0.7em; opacity:0.8;">Official MV</div></div></button>
                    <button class="track-btn" onclick="changeVideo(this, 'BV1Ng4y1D78J')"><span class="track-icon">âœ¨</span><div style="text-align:left;"><div style="font-weight:bold;">Enchanted</div><div style="font-size:0.7em; opacity:0.8;">Taylor's Version</div></div></button>
                    <button class="track-btn" onclick="changeVideo(this, 'BV1gr42137rc')"><span class="track-icon">ğŸŒ§ï¸</span><div style="text-align:left;"><div style="font-weight:bold;">TTPD White Noise</div><div style="font-size:0.7em; opacity:0.8;">4 Hours</div></div></button>
                </div>
            </div>
            <div class="footer">Made with â¤ï¸ by Lily for Iris</div>
        </div>
    </div>

    <div class="npc-container">
        <div class="dialogue-box" id="npc-dialogue">ä½ å¥½å‘€ï¼ŒIrisã€‚æˆ‘æ˜¯ Elianã€‚ç‚¹å‡»æˆ‘å¯ä»¥å’Œæˆ‘èŠå¤©å“¦ã€‚</div>
        <img id="npc-img" class="npc-image" src="assets/characters/elian/neutral.png?v=new" onclick="toggleChat()">
        <div class="chat-input-box" id="chat-box">
            <input type="text" id="chat-input" placeholder="å’Œ Elian è¯´ç‚¹ä»€ä¹ˆ..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script src="js/planting.js?v=fixed"></script>
    <script src="js/sakura.js?v=fixed"></script>

    <script>
        fetch('diary.json?t=' + new Date().getTime()).then(r => r.json()).then(d => {
            const c = document.getElementById('diary-container'); c.innerHTML = '';
            (Array.isArray(d) ? d : [d]).forEach(e => { c.innerHTML += `<div class="diary-card"><span class="diary-date">${e.date}</span><div class="diary-content">${e.content}</div></div>`; });
        }).catch(e => console.log('æ—¥è®°å¤±è´¥', e));

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            const btn = document.querySelector('.magic-switch');
            btn.innerText = document.body.classList.contains('night-mode') ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        function changeVideo(btn, bvid) {
            document.getElementById('bili-player').src = `//player.bilibili.com/player.html?bvid=${bvid}&page=1&high_quality=1&danmaku=0`;
            document.querySelectorAll('.track-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        let isChatting = false;
        function toggleChat() {
            const box = document.getElementById('chat-box');
            isChatting = !isChatting;
            if (isChatting) { box.classList.add('show'); document.getElementById('chat-input').focus(); } else { box.classList.remove('show'); }
        }

        function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }

        let ttsAudio = new Audio(); 

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if (!text) return;

            const box = document.getElementById('npc-dialogue');
            box.innerText = `Iris: ${text}`;
            box.classList.add('show');
            input.value = '';

            // é™éŸ³è§£é” Audio Context
            ttsAudio.src = 'data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq';
            ttsAudio.play().catch(() => {});

            // æ¸…é™¤æ—§çš„æŒ‰é’®
            const oldBtn = box.querySelector('.tts-play-btn');
            if(oldBtn) oldBtn.remove();

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                
                if (!res.ok) throw new Error("API Error");
                
                const data = await res.json();
                
                if (data.emotion) document.getElementById('npc-img').src = `assets/characters/elian/${data.emotion}.png?v=new`;
                if (data.reply) box.innerText = data.reply;
                
                if (data.action && data.action !== 'none') {
                    if (data.action === 'set_night' && !document.body.classList.contains('night-mode')) toggleNightMode();
                    else if (data.action === 'set_day' && document.body.classList.contains('night-mode')) toggleNightMode();
                    else if (data.action.startsWith('play_')) {
                        const track = data.action.replace('play_', '');
                        const map = { 'jazz': 'BV1jA411L7fe', 'cardigan': 'BV1Np4y1V7cd', 'willow': 'BV1c4v1e1ERF', 'enchanted': 'BV1Ng4y1D78J', 'noise': 'BV1gr42137rc' };
                        if (map[track]) document.getElementById('bili-player').src = `//player.bilibili.com/player.html?bvid=${map[track]}&page=1&high_quality=1&danmaku=0`;
                    }
                }

                if (data.reply) {
                    try {
                        const ttsRes = await fetch('/api/tts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: data.reply })
                        });
                        if (ttsRes.ok) {
                            const blob = await ttsRes.blob();
                            const audioUrl = URL.createObjectURL(blob);
                            ttsAudio.src = audioUrl;
                            ttsAudio.play().catch(e => {
                                console.log("Still blocked, showing BIG button:", e);
                                const btn = document.createElement('button');
                                btn.innerText = 'ğŸ”Š';
                                btn.className = 'tts-play-btn';
                                btn.onclick = () => ttsAudio.play();
                                box.appendChild(btn);
                            });
                        }
                    } catch (e) { console.log("TTS Error:", e); }
                }

            } catch (e) {
                console.log("Chat Failed:", e);
                localChatLogic(text);
            }
        }

        function localChatLogic(text) {
            const box = document.getElementById('npc-dialogue');
            const responses = ["æˆ‘åœ¨å¬ç€å‘¢ã€‚", "åªè¦ä½ åœ¨ï¼Œæˆ‘å°±å¾ˆå¼€å¿ƒã€‚", "æƒ³å¬ä¸ªæ•…äº‹å—ï¼Ÿ"];
            const reply = responses[Math.floor(Math.random() * responses.length)];
            setTimeout(() => { box.innerText = reply; }, 1000);
        }
    </script>
</body>
</html>